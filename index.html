<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>SIPEKA - Sistem Informasi Pencatatan Keuangan Sederhana</title>
    
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#6a1b9a" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
      :root {
        --primary: #4361ee;
        --primary-light: #4895ef;
        --secondary: #3f37c9;
        --success: #4cc9f0;
        --danger: #f72585;
        --warning: #f8961e;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --light-gray: #e9ecef;
        --border-radius: 12px;
        --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f7fb;
        color: var(--dark);
        font-size: 14px;
        line-height: 1.5;
        min-height: 100vh;
      }

      /* Container utama */
      #app-container {
        min-height: 100vh;
      }

      /* Halaman Auth (Login/Register) */
      .auth-page {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.5),
            rgba(0, 0, 0, 0.5)
          ),
          url("https://images.unsplash.com/photo-1762427354051-a9bdb181ae3b?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }

      .auth-container {
        width: 100%;
        max-width: 400px;
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
      }

      .auth-header {
        padding: 30px 20px;
        text-align: center;
        background-color: var(--primary);
        color: white;
      }

      .auth-logo {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-weight: 700;
        font-size: 1.5rem;
        margin-bottom: 10px;
      }

      .auth-logo i {
        font-size: 1.8rem;
      }

      .auth-tabs {
        display: flex;
        border-bottom: 1px solid var(--light-gray);
      }

      .auth-tab {
        flex: 1;
        padding: 15px;
        text-align: center;
        font-weight: 500;
        color: var(--gray);
        background: none;
        border: none;
        cursor: pointer;
        transition: var(--transition);
      }

      .auth-tab.active {
        color: var(--primary);
        border-bottom: 2px solid var(--primary);
      }

      .auth-content {
        padding: 30px 25px;
      }

      .auth-form {
        display: none;
      }

      .auth-form.active {
        display: block;
        animation: fadeIn 0.4s ease;
      }

      /* Halaman Aplikasi */
      .main-app {
        display: none;
        min-height: 100vh;
        padding-bottom: 80px;
      }

      .container {
        width: 100%;
        max-width: 100%;
        padding: 0 15px;
        margin: 0 auto;
      }

      /* Header */
      .header {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 20px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        font-size: 1.3rem;
      }

      .logo i {
        font-size: 1.5rem;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      /* Navigasi */
      .nav-tabs {
        display: flex;
        background-color: white;
        border-bottom: 1px solid var(--light-gray);
        overflow-x: auto;
        white-space: nowrap;
        position: sticky;
        top: 76px;
        z-index: 99;
      }

      .nav-tab {
        flex: 1;
        padding: 15px 10px;
        text-align: center;
        font-weight: 500;
        color: var(--gray);
        border-bottom: 3px solid transparent;
        transition: var(--transition);
      }

      .nav-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }

      .nav-tab i {
        margin-right: 5px;
        font-size: 1.1rem;
      }

      /* Konten */
      .content {
        padding: 20px 0;
        min-height: calc(100vh - 156px);
      }

      .page {
        display: none;
        animation: fadeIn 0.4s ease;
      }

      .page.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Kartu */
      .card {
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 20px;
        margin-bottom: 20px;
        transition: var(--transition);
      }

      .card:hover {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      }

      .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--dark);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* Dashboard */
      .balance-cards {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 25px;
      }

      .balance-card {
        text-align: center;
        padding: 15px 10px;
        border-radius: var(--border-radius);
        color: white;
      }

      .balance-card.total {
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-light)
        );
      }

      .balance-card.income {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
      }

      .balance-card.expense {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }

      .balance-card .amount {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 5px 0;
      }

      .balance-card .label {
        font-size: 0.85rem;
        opacity: 0.9;
      }

      .chart-container {
        height: 250px;
        margin: 20px 0;
        position: relative;
      }

      /* Form */
      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--dark);
      }

      .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--light-gray);
        border-radius: 8px;
        font-size: 1rem;
        transition: var(--transition);
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
      }

      .select-wrapper {
        position: relative;
      }

      .select-wrapper:after {
        content: "\f078";
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        color: var(--gray);
      }

      .form-control.select {
        appearance: none;
        padding-right: 40px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      /* Tombol */
      .btn {
        display: inline-block;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
      }

      .btn-block {
        display: block;
        width: 100%;
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background-color: var(--secondary);
      }

      .btn-secondary {
        background-color: var(--light-gray);
        color: var(--dark);
      }

      .btn-secondary:hover {
        background-color: #dde1e7;
      }

      .btn-success {
        background-color: #2ecc71;
        color: white;
      }

      .btn-success:hover {
        background-color: #27ae60;
      }

      .btn-danger {
        background-color: var(--danger);
        color: white;
      }

      .btn-danger:hover {
        background-color: #e11575;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 0.85rem;
      }

      .btn-icon {
        padding: 8px;
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
      }

      /* Tabel dan Daftar */
      .transaction-list {
        list-style: none;
      }

      .transaction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid var(--light-gray);
      }

      .transaction-item:last-child {
        border-bottom: none;
      }

      .transaction-info {
        flex: 1;
      }

      .transaction-title {
        font-weight: 500;
        margin-bottom: 5px;
      }

      .transaction-meta {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.85rem;
        color: var(--gray);
      }

      .transaction-amount {
        font-weight: 600;
        font-size: 1.1rem;
      }

      .transaction-amount.income {
        color: #2ecc71;
      }

      .transaction-amount.expense {
        color: #e74c3c;
      }

      .transaction-actions {
        display: flex;
        gap: 8px;
      }

      .category-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .badge-income {
        background-color: rgba(46, 204, 113, 0.15);
        color: #27ae60;
      }

      .badge-expense {
        background-color: rgba(231, 76, 60, 0.15);
        color: #c0392b;
      }

      /* Tab akun */
      .account-tabs {
        display: flex;
        overflow-x: auto;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 5px;
      }

      .account-tab {
        padding: 10px 20px;
        background-color: white;
        border-radius: 20px;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--light-gray);
        transition: var(--transition);
      }

      .account-tab.active {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      /* Modal */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 15px;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
      }

      .modal.active {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background-color: white;
        border-radius: var(--border-radius);
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        transform: translateY(20px);
        transition: var(--transition);
      }

      .modal.active .modal-content {
        transform: translateY(0);
      }

      .modal-header {
        padding: 20px;
        border-bottom: 1px solid var(--light-gray);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 1.2rem;
        font-weight: 600;
      }

      .modal-body {
        padding: 20px;
      }

      .modal-footer {
        padding: 20px;
        border-top: 1px solid var(--light-gray);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--gray);
        cursor: pointer;
      }

      /* Notifikasi */
      .notification {
        position: fixed;
        bottom: 90px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--dark);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
      }

      .notification.active {
        opacity: 1;
        visibility: visible;
      }

      .notification.success {
        background-color: #2ecc71;
      }

      .notification.error {
        background-color: #e74c3c;
      }

      /* Footer navigasi */
      .footer-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: white;
        display: flex;
        justify-content: space-around;
        padding: 12px 0;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.08);
        z-index: 99;
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: var(--gray);
        text-decoration: none;
        font-size: 0.8rem;
        transition: var(--transition);
        cursor: pointer;
      }

      .nav-item i {
        font-size: 1.2rem;
        margin-bottom: 5px;
      }

      .nav-item.active {
        color: var(--primary);
      }

      .add-transaction-btn {
        position: fixed;
        bottom: 70px;
        right: 20px;
        width: 60px;
        height: 60px;
        background-color: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        cursor: pointer;
        z-index: 98;
        transition: var(--transition);
      }

      .add-transaction-btn:hover {
        background-color: var(--secondary);
        transform: scale(1.05);
      }

      /* Tema */
      body.dark-theme {
        background-color: #121826;
        color: #e0e0e0;
      }

      body.dark-theme .card {
        background-color: #1e293b;
        color: #e0e0e0;
      }

      body.dark-theme .header {
        background: linear-gradient(135deg, #1e40af, #3730a3);
      }

      body.dark-theme .form-control {
        background-color: #2d3748;
        border-color: #4a5568;
        color: #e0e0e0;
      }

      body.dark-theme .nav-tabs {
        background-color: #1e293b;
        border-bottom-color: #374151;
      }

      body.dark-theme .transaction-item {
        border-bottom-color: #374151;
      }

      body.dark-theme .auth-page {
        background: linear-gradient(135deg, #1e40af, #3730a3);
      }

      body.dark-theme .auth-container {
        background-color: #1e293b;
        color: #e0e0e0;
      }

      body.dark-theme .auth-header {
        background-color: #1e40af;
      }

      body.dark-theme .auth-tabs {
        border-bottom-color: #374151;
      }

      body.dark-theme .auth-tab {
        color: #9ca3af;
      }

      body.dark-theme .auth-tab.active {
        color: #60a5fa;
        border-bottom-color: #60a5fa;
      }

      /* Responsif */
      @media (max-width: 480px) {
        .balance-cards {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .form-row {
          grid-template-columns: 1fr;
          gap: 0;
        }

        .chart-container {
          height: 200px;
        }

        .auth-container {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Container Utama -->
    <div id="app-container">
      <!-- Halaman Auth (Login/Register) -->
      <div class="auth-page" id="auth-page">
        <div class="auth-container">
          <div class="auth-header">
            <div class="auth-logo">
              <i class="fas fa-chart-line"></i>
              <span>SIPEKA</span>
            </div>
            <p>Sistem Informasi Pencatatan Keuangan Sederhana</p>
          </div>

          <div class="auth-tabs">
            <button class="auth-tab active" data-form="login-form">
              Masuk
            </button>
            <button class="auth-tab" data-form="register-form">Daftar</button>
          </div>

          <div class="auth-content">
            <!-- Form Login -->
            <form class="auth-form active" id="login-form">
              <div class="form-group">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="loginEmail"
                  placeholder="Masukkan email"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="loginPassword"
                  placeholder="Masukkan password"
                  required
                />
              </div>
              <div class="form-group">
                <button
                  type="button"
                  class="btn btn-primary btn-block"
                  id="loginBtn"
                >
                  Masuk
                </button>
              </div>
              <div class="form-group text-center">
                <p>
                  Belum punya akun?
                  <a href="#" id="switch-to-register">Daftar disini</a>
                </p>
              </div>
            </form>

            <!-- Form Register -->
            <form class="auth-form" id="register-form">
              <div class="form-group">
                <label class="form-label">Nama Lengkap</label>
                <input
                  type="text"
                  class="form-control"
                  id="registerName"
                  placeholder="Masukkan nama lengkap"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="registerEmail"
                  placeholder="Masukkan email"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="registerPassword"
                  placeholder="Masukkan password"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label">Konfirmasi Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="registerConfirmPassword"
                  placeholder="Konfirmasi password"
                  required
                />
              </div>
              <div class="form-group">
                <button
                  type="button"
                  class="btn btn-primary btn-block"
                  id="registerBtn"
                >
                  Daftar
                </button>
              </div>
              <div class="form-group text-center">
                <p>
                  Sudah punya akun?
                  <a href="#" id="switch-to-login">Masuk disini</a>
                </p>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Halaman Aplikasi Utama (akan ditampilkan setelah login) -->
      <div class="main-app" id="main-app">
        <!-- Header -->
        <div class="header">
          <div class="logo">
            <i class="fas fa-chart-line"></i>
            <span>FinTrack</span>
          </div>
          <div class="user-info">
            <div class="user-avatar" id="userInitial">U</div>
            <span id="userName">Pengguna</span>
          </div>
        </div>

        <!-- Navigasi Tab -->
        <div class="nav-tabs">
          <div class="nav-tab active" data-page="dashboard">
            <i class="fas fa-home"></i> Beranda
          </div>
          <div class="nav-tab" data-page="transactions">
            <i class="fas fa-list"></i> Riwayat
          </div>
          <div class="nav-tab" data-page="statistics">
            <i class="fas fa-chart-bar"></i> Statistik
          </div>
          <div class="nav-tab" data-page="settings">
            <i class="fas fa-cog"></i> Pengaturan
          </div>
        </div>

        <!-- Konten Halaman -->
        <div class="container content">
          <!-- Halaman Dashboard -->
          <div class="page active" id="dashboard">
            <div class="account-tabs" id="accountTabsDashboard"></div>

            <div class="balance-cards">
              <div class="balance-card total">
                <i class="fas fa-wallet"></i>
                <div class="amount" id="totalBalance">Rp 0</div>
                <div class="label">Total Saldo</div>
              </div>
              <div class="balance-card income">
                <i class="fas fa-arrow-down"></i>
                <div class="amount" id="totalIncome">Rp 0</div>
                <div class="label">Pemasukan</div>
              </div>
              <div class="balance-card expense">
                <i class="fas fa-arrow-up"></i>
                <div class="amount" id="totalExpense">Rp 0</div>
                <div class="label">Pengeluaran</div>
              </div>
            </div>

            <div class="card">
              <div class="card-title">
                <span>Statistik Bulan Ini</span>
                <span id="currentMonth"></span>
              </div>
              <div class="chart-container">
                <canvas id="barChart"></canvas>
              </div>
            </div>

            <div class="card">
              <div class="card-title">Pengeluaran per Kategori</div>
              <div class="chart-container">
                <canvas id="pieChart"></canvas>
              </div>
            </div>

            <div class="card">
              <div class="card-title">Transaksi Terbaru</div>
              <ul class="transaction-list" id="recentTransactions"></ul>
            </div>
          </div>

          <!-- Halaman Riwayat Transaksi -->
          <div class="page" id="transactions">
            <div class="account-tabs" id="accountTabsTransactions"></div>

            <div class="card">
              <div class="card-title">
                <span>Riwayat Transaksi</span>
                <div>
                  <button class="btn btn-secondary btn-small" id="filterAll">
                    Semua
                  </button>
                  <button class="btn btn-secondary btn-small" id="filterIncome">
                    Pemasukan
                  </button>
                  <button
                    class="btn btn-secondary btn-small"
                    id="filterExpense"
                  >
                    Pengeluaran
                  </button>
                </div>
              </div>
              <ul class="transaction-list" id="transactionHistory"></ul>
            </div>
          </div>

          <!-- Halaman Statistik -->
          <div class="page" id="statistics">
            <div class="account-tabs" id="accountTabsStatistics"></div>

            <div class="card">
              <div class="card-title">Laporan Keuangan</div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Periode</label>
                  <div class="select-wrapper">
                    <select class="form-control select" id="reportPeriod">
                      <option value="monthly">Bulanan</option>
                      <option value="yearly">Tahunan</option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label" id="periodLabel">Bulan</label>
                  <div class="select-wrapper">
                    <select class="form-control select" id="reportMonth">
                      <!-- Opsi bulan akan diisi oleh JavaScript -->
                    </select>
                  </div>
                </div>
              </div>
              <button class="btn btn-primary btn-block" id="generateReport">
                Hasilkan Laporan
              </button>
            </div>

            <div class="card" id="reportResult" style="display: none">
              <div class="card-title">
                <span>Hasil Laporan</span>
                <button class="btn btn-success btn-small" id="exportPDF">
                  Export PDF
                </button>
              </div>
              <div id="reportContent"></div>
            </div>
          </div>

          <!-- Halaman Pengaturan -->
          <div class="page" id="settings">
            <div class="card">
              <div class="card-title">Profil Pengguna</div>
              <div class="form-group">
                <label class="form-label">Nama Lengkap</label>
                <input
                  type="text"
                  class="form-control"
                  id="userFullName"
                  placeholder="Masukkan nama lengkap"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="userEmail"
                  placeholder="Masukkan email"
                />
              </div>
              <button class="btn btn-primary btn-block" id="updateProfile">
                Perbarui Profil
              </button>
            </div>

            <div class="card">
              <div class="card-title">Kelola Akun Keuangan</div>
              <div id="accountList"></div>
              <button class="btn btn-secondary btn-block" id="addAccountBtn">
                Tambah Akun Baru
              </button>
            </div>

            <div class="card">
              <div class="card-title">Tema Aplikasi</div>
              <div class="form-group">
                <div class="select-wrapper">
                  <select class="form-control select" id="themeSelect">
                    <option value="light">Tema Terang</option>
                    <option value="dark">Tema Gelap</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-title">Keluar</div>
              <button class="btn btn-danger btn-block" id="logoutBtn">
                Keluar dari Aplikasi
              </button>
            </div>
          </div>
        </div>

        <!-- Tombol Tambah Transaksi -->
        <div class="add-transaction-btn" id="addTransactionBtn">
          <i class="fas fa-plus"></i>
        </div>

        <!-- Footer Navigasi -->
        <div class="footer-nav">
          <div class="nav-item active" data-page="dashboard">
            <i class="fas fa-home"></i>
            <span>Beranda</span>
          </div>
          <div class="nav-item" data-page="transactions">
            <i class="fas fa-exchange-alt"></i>
            <span>Transaksi</span>
          </div>
          <div class="nav-item" data-page="statistics">
            <i class="fas fa-chart-pie"></i>
            <span>Laporan</span>
          </div>
          <div class="nav-item" data-page="settings">
            <i class="fas fa-user-cog"></i>
            <span>Akun</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Tambah Transaksi -->
    <div class="modal" id="transactionModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Tambah Transaksi</div>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Jenis Transaksi</label>
            <div class="select-wrapper">
              <select class="form-control select" id="transactionType">
                <option value="income">Pemasukan</option>
                <option value="expense">Pengeluaran</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Kategori</label>
            <div class="select-wrapper">
              <select class="form-control select" id="transactionCategory">
                <!-- Kategori akan diisi oleh JavaScript -->
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Jumlah (Rp)</label>
            <input
              type="number"
              class="form-control"
              id="transactionAmount"
              placeholder="Masukkan jumlah"
              min="0"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Deskripsi</label>
            <input
              type="text"
              class="form-control"
              id="transactionDescription"
              placeholder="Masukkan deskripsi"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Tanggal</label>
            <input type="date" class="form-control" id="transactionDate" />
          </div>
          <div class="form-group">
            <label class="form-label">Akun Keuangan</label>
            <div class="select-wrapper">
              <select class="form-control select" id="transactionAccount">
                <!-- Akun akan diisi oleh JavaScript -->
              </select>
            </div>
          </div>
          <input type="hidden" id="transactionId" />
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelTransaction">
            Batal
          </button>
          <button class="btn btn-primary" id="saveTransaction">Simpan</button>
        </div>
      </div>
    </div>

    <!-- Modal Tambah Akun -->
    <div class="modal" id="accountModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Tambah Akun Keuangan</div>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nama Akun</label>
            <input
              type="text"
              class="form-control"
              id="accountName"
              placeholder="Contoh: Tabungan Bank, Dompet, dll."
            />
          </div>
          <div class="form-group">
            <label class="form-label">Saldo Awal (Rp)</label>
            <input
              type="number"
              class="form-control"
              id="accountBalance"
              placeholder="Masukkan saldo awal"
              min="0"
              value="0"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Warna Akun</label>
            <input
              type="color"
              class="form-control"
              id="accountColor"
              value="#4361ee"
            />
          </div>
          <input type="hidden" id="accountId" />
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelAccount">Batal</button>
          <button class="btn btn-primary" id="saveAccount">Simpan</button>
        </div>
      </div>
    </div>

    <!-- Notifikasi -->
    <div class="notification" id="notification"></div>

    <script>
      // Inisialisasi aplikasi
      document.addEventListener("DOMContentLoaded", function () {
        // Data aplikasi
        const app = {
          currentUser: null,
          currentAccount: null,
          users: JSON.parse(localStorage.getItem("fintrack_users")) || [],
          accounts: JSON.parse(localStorage.getItem("fintrack_accounts")) || [],
          transactions:
            JSON.parse(localStorage.getItem("fintrack_transactions")) || [],
          categories: {
            income: ["Gaji", "Bonus", "Investasi", "Hadiah", "Lainnya"],
            expense: [
              "Makanan",
              "Transportasi",
              "Hiburan",
              "Kesehatan",
              "Belanja",
              "Pendidikan",
              "Tagihan",
              "Lainnya",
            ],
          },
          currentFilter: "all",
        };

        // Inisialisasi Chart.js
        let barChart = null;
        let pieChart = null;

        // Elemen DOM
        const elements = {
          // Halaman
          authPage: document.getElementById("auth-page"),
          mainApp: document.getElementById("main-app"),

          // Auth elements
          loginForm: document.getElementById("login-form"),
          registerForm: document.getElementById("register-form"),
          loginEmail: document.getElementById("loginEmail"),
          loginPassword: document.getElementById("loginPassword"),
          registerName: document.getElementById("registerName"),
          registerEmail: document.getElementById("registerEmail"),
          registerPassword: document.getElementById("registerPassword"),
          registerConfirmPassword: document.getElementById(
            "registerConfirmPassword"
          ),
          loginBtn: document.getElementById("loginBtn"),
          registerBtn: document.getElementById("registerBtn"),
          switchToLogin: document.getElementById("switch-to-login"),
          switchToRegister: document.getElementById("switch-to-register"),
          authTabs: document.querySelectorAll(".auth-tab"),

          // Modal
          transactionModal: document.getElementById("transactionModal"),
          accountModal: document.getElementById("accountModal"),

          // Input form transaksi
          transactionType: document.getElementById("transactionType"),
          transactionCategory: document.getElementById("transactionCategory"),
          transactionAmount: document.getElementById("transactionAmount"),
          transactionDescription: document.getElementById(
            "transactionDescription"
          ),
          transactionDate: document.getElementById("transactionDate"),
          transactionAccount: document.getElementById("transactionAccount"),
          transactionId: document.getElementById("transactionId"),

          // Input form akun
          accountName: document.getElementById("accountName"),
          accountBalance: document.getElementById("accountBalance"),
          accountColor: document.getElementById("accountColor"),
          accountId: document.getElementById("accountId"),

          // Tombol
          saveTransaction: document.getElementById("saveTransaction"),
          cancelTransaction: document.getElementById("cancelTransaction"),
          saveAccount: document.getElementById("saveAccount"),
          cancelAccount: document.getElementById("cancelAccount"),
          addTransactionBtn: document.getElementById("addTransactionBtn"),
          addAccountBtn: document.getElementById("addAccountBtn"),
          updateProfile: document.getElementById("updateProfile"),
          logoutBtn: document.getElementById("logoutBtn"),
          generateReport: document.getElementById("generateReport"),
          exportPDF: document.getElementById("exportPDF"),

          // Filter transaksi
          filterAll: document.getElementById("filterAll"),
          filterIncome: document.getElementById("filterIncome"),
          filterExpense: document.getElementById("filterExpense"),

          // Laporan
          reportPeriod: document.getElementById("reportPeriod"),
          reportMonth: document.getElementById("reportMonth"),
          periodLabel: document.getElementById("periodLabel"),
          reportResult: document.getElementById("reportResult"),
          reportContent: document.getElementById("reportContent"),

          // Tampilan dashboard
          totalBalance: document.getElementById("totalBalance"),
          totalIncome: document.getElementById("totalIncome"),
          totalExpense: document.getElementById("totalExpense"),
          currentMonth: document.getElementById("currentMonth"),
          recentTransactions: document.getElementById("recentTransactions"),
          transactionHistory: document.getElementById("transactionHistory"),

          // Tab akun
          accountTabsDashboard: document.getElementById("accountTabsDashboard"),
          accountTabsTransactions: document.getElementById(
            "accountTabsTransactions"
          ),
          accountTabsStatistics: document.getElementById(
            "accountTabsStatistics"
          ),
          accountList: document.getElementById("accountList"),

          // Profil pengguna
          userInitial: document.getElementById("userInitial"),
          userName: document.getElementById("userName"),
          userFullName: document.getElementById("userFullName"),
          userEmail: document.getElementById("userEmail"),
          themeSelect: document.getElementById("themeSelect"),

          // Notifikasi
          notification: document.getElementById("notification"),
        };

        // Inisialisasi tanggal
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        const monthNames = [
          "Januari",
          "Februari",
          "Maret",
          "April",
          "Mei",
          "Juni",
          "Juli",
          "Agustus",
          "September",
          "Oktober",
          "November",
          "Desember",
        ];

        // Set tanggal default untuk input transaksi
        elements.transactionDate.value = today.toISOString().split("T")[0];

        // Set bulan saat ini di dashboard
        elements.currentMonth.textContent = `${monthNames[currentMonth]} ${currentYear}`;

        // Isi opsi bulan untuk laporan
        function populateMonthOptions() {
          elements.reportMonth.innerHTML = "";
          const months = [
            "Januari",
            "Februari",
            "Maret",
            "April",
            "Mei",
            "Juni",
            "Juli",
            "Agustus",
            "September",
            "Oktober",
            "November",
            "Desember",
          ];

          months.forEach((month, index) => {
            const option = document.createElement("option");
            option.value = index;
            option.textContent = month;
            if (index === currentMonth) {
              option.selected = true;
            }
            elements.reportMonth.appendChild(option);
          });
        }

        populateMonthOptions();

        // Fungsi notifikasi
        function showNotification(message, type = "success") {
          elements.notification.textContent = message;
          elements.notification.className = `notification ${type} active`;

          setTimeout(() => {
            elements.notification.classList.remove("active");
          }, 3000);
        }

        // Fungsi untuk menutup modal
        function closeModal(modalId) {
          const modal = document.getElementById(modalId);
          modal.classList.remove("active");
        }

        // Fungsi untuk membuka modal
        function openModal(modalId) {
          const modal = document.getElementById(modalId);
          modal.classList.add("active");
        }

        // Event listener untuk menutup modal
        document.querySelectorAll(".close-modal").forEach((button) => {
          button.addEventListener("click", function () {
            const modal = this.closest(".modal");
            modal.classList.remove("active");
          });
        });

        // Event listener untuk tab auth (login/register)
        elements.authTabs.forEach((tab) => {
          tab.addEventListener("click", function () {
            const formId = this.getAttribute("data-form");

            // Update tab aktif
            elements.authTabs.forEach((t) => t.classList.remove("active"));
            this.classList.add("active");

            // Update form aktif
            document
              .querySelectorAll(".auth-form")
              .forEach((form) => form.classList.remove("active"));
            document.getElementById(formId).classList.add("active");
          });
        });

        // Event listener untuk switch antara login dan register
        elements.switchToLogin.addEventListener("click", function (e) {
          e.preventDefault();
          elements.authTabs.forEach((t) => t.classList.remove("active"));
          document
            .querySelector('.auth-tab[data-form="login-form"]')
            .classList.add("active");

          document
            .querySelectorAll(".auth-form")
            .forEach((form) => form.classList.remove("active"));
          elements.loginForm.classList.add("active");
        });

        elements.switchToRegister.addEventListener("click", function (e) {
          e.preventDefault();
          elements.authTabs.forEach((t) => t.classList.remove("active"));
          document
            .querySelector('.auth-tab[data-form="register-form"]')
            .classList.add("active");

          document
            .querySelectorAll(".auth-form")
            .forEach((form) => form.classList.remove("active"));
          elements.registerForm.classList.add("active");
        });

        // Event listener untuk navigasi tab
        document.querySelectorAll(".nav-tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            const pageId = this.getAttribute("data-page");

            // Update tab aktif
            document
              .querySelectorAll(".nav-tab")
              .forEach((t) => t.classList.remove("active"));
            this.classList.add("active");

            // Update halaman aktif
            document
              .querySelectorAll(".page")
              .forEach((page) => page.classList.remove("active"));
            document.getElementById(pageId).classList.add("active");

            // Update footer navigasi
            document.querySelectorAll(".nav-item").forEach((item) => {
              item.classList.remove("active");
              if (item.getAttribute("data-page") === pageId) {
                item.classList.add("active");
              }
            });
          });
        });

        // Event listener untuk footer navigasi
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.addEventListener("click", function () {
            const pageId = this.getAttribute("data-page");

            // Update footer navigasi aktif
            document
              .querySelectorAll(".nav-item")
              .forEach((i) => i.classList.remove("active"));
            this.classList.add("active");

            // Update tab aktif
            document
              .querySelectorAll(".nav-tab")
              .forEach((tab) => tab.classList.remove("active"));
            document
              .querySelector(`.nav-tab[data-page="${pageId}"]`)
              .classList.add("active");

            // Update halaman aktif
            document
              .querySelectorAll(".page")
              .forEach((page) => page.classList.remove("active"));
            document.getElementById(pageId).classList.add("active");
          });
        });

        // Fungsi untuk menyimpan data ke localStorage
        function saveData() {
          localStorage.setItem("fintrack_users", JSON.stringify(app.users));
          localStorage.setItem(
            "fintrack_accounts",
            JSON.stringify(app.accounts)
          );
          localStorage.setItem(
            "fintrack_transactions",
            JSON.stringify(app.transactions)
          );
          localStorage.setItem(
            "fintrack_current_user",
            JSON.stringify(app.currentUser)
          );
          localStorage.setItem(
            "fintrack_current_account",
            JSON.stringify(app.currentAccount)
          );
        }

        // Fungsi untuk memuat data dari localStorage
        function loadData() {
          const savedUser = JSON.parse(
            localStorage.getItem("fintrack_current_user")
          );
          const savedAccount = JSON.parse(
            localStorage.getItem("fintrack_current_account")
          );

          if (savedUser) {
            app.currentUser = savedUser;
            app.currentAccount = savedAccount;

            // Tampilkan aplikasi utama dan sembunyikan halaman auth
            elements.authPage.style.display = "none";
            elements.mainApp.style.display = "block";

            // Tampilkan data pengguna
            updateUserDisplay();

            // Muat akun dan transaksi
            loadAccounts();
            loadTransactions();
            updateDashboard();

            // Periksa tema
            checkTheme();
          }
        }

        // Fungsi untuk memeriksa dan menerapkan tema
        function checkTheme() {
          const savedTheme = localStorage.getItem("fintrack_theme") || "light";
          elements.themeSelect.value = savedTheme;

          if (savedTheme === "dark") {
            document.body.classList.add("dark-theme");
          } else {
            document.body.classList.remove("dark-theme");
          }
        }

        // Event listener untuk perubahan tema
        elements.themeSelect.addEventListener("change", function () {
          const theme = this.value;
          localStorage.setItem("fintrack_theme", theme);

          if (theme === "dark") {
            document.body.classList.add("dark-theme");
          } else {
            document.body.classList.remove("dark-theme");
          }

          showNotification("Tema berhasil diubah", "success");
        });

        // Fungsi untuk update tampilan pengguna
        function updateUserDisplay() {
          if (app.currentUser) {
            const initial = app.currentUser.name.charAt(0).toUpperCase();
            elements.userInitial.textContent = initial;
            elements.userName.textContent = app.currentUser.name;
            elements.userFullName.value = app.currentUser.name;
            elements.userEmail.value = app.currentUser.email;
          }
        }

        // Fungsi untuk login pengguna
        elements.loginBtn.addEventListener("click", function () {
          const email = elements.loginEmail.value.trim();
          const password = elements.loginPassword.value;

          // Validasi
          if (!email || !password) {
            showNotification("Harap isi semua field", "error");
            return;
          }

          // Cari pengguna
          const user = app.users.find(
            (user) => user.email === email && user.password === password
          );

          if (!user) {
            showNotification("Email atau password salah", "error");
            return;
          }

          // Set pengguna saat ini
          app.currentUser = user;

          // Cari akun default atau pertama
          const userAccounts = app.accounts.filter(
            (account) => account.userId === user.id
          );
          if (userAccounts.length > 0) {
            app.currentAccount = userAccounts[0];
          } else {
            // Buat akun default jika tidak ada
            const defaultAccount = {
              id: Date.now().toString() + "_acc",
              userId: user.id,
              name: "Tabungan Utama",
              balance: 0,
              color: "#4361ee",
              createdAt: new Date().toISOString(),
            };

            app.accounts.push(defaultAccount);
            app.currentAccount = defaultAccount;
          }

          // Simpan data
          saveData();

          // Tampilkan notifikasi
          showNotification("Login berhasil!", "success");

          // Tampilkan aplikasi utama dan sembunyikan halaman auth
          elements.authPage.style.display = "none";
          elements.mainApp.style.display = "block";

          // Update tampilan pengguna
          updateUserDisplay();

          // Muat data
          loadAccounts();
          updateDashboard();
          checkTheme();

          // Reset form login
          elements.loginEmail.value = "";
          elements.loginPassword.value = "";
        });

        // Fungsi untuk registrasi pengguna
        elements.registerBtn.addEventListener("click", function () {
          const name = elements.registerName.value.trim();
          const email = elements.registerEmail.value.trim();
          const password = elements.registerPassword.value;
          const confirmPassword = elements.registerConfirmPassword.value;

          // Validasi
          if (!name || !email || !password || !confirmPassword) {
            showNotification("Harap isi semua field", "error");
            return;
          }

          if (password !== confirmPassword) {
            showNotification("Password tidak cocok", "error");
            return;
          }

          if (password.length < 6) {
            showNotification("Password minimal 6 karakter", "error");
            return;
          }

          // Cek apakah email sudah terdaftar
          const existingUser = app.users.find((user) => user.email === email);
          if (existingUser) {
            showNotification("Email sudah terdaftar", "error");
            return;
          }

          // Buat pengguna baru
          const newUser = {
            id: Date.now().toString(),
            name: name,
            email: email,
            password: password,
            createdAt: new Date().toISOString(),
          };

          app.users.push(newUser);
          app.currentUser = newUser;

          // Buat akun default
          const defaultAccount = {
            id: Date.now().toString() + "_acc",
            userId: newUser.id,
            name: "Tabungan Utama",
            balance: 0,
            color: "#4361ee",
            createdAt: new Date().toISOString(),
          };

          app.accounts.push(defaultAccount);
          app.currentAccount = defaultAccount;

          // Simpan data
          saveData();

          // Tampilkan notifikasi
          showNotification(
            "Registrasi berhasil! Akun default telah dibuat.",
            "success"
          );

          // Tampilkan aplikasi utama dan sembunyikan halaman auth
          elements.authPage.style.display = "none";
          elements.mainApp.style.display = "block";

          // Update tampilan pengguna
          updateUserDisplay();

          // Muat data
          loadAccounts();
          updateDashboard();
          checkTheme();

          // Reset form register
          elements.registerName.value = "";
          elements.registerEmail.value = "";
          elements.registerPassword.value = "";
          elements.registerConfirmPassword.value = "";
        });

        // Fungsi untuk memuat dan menampilkan akun
        function loadAccounts() {
          if (!app.currentUser) return;

          const userAccounts = app.accounts.filter(
            (account) => account.userId === app.currentUser.id
          );

          // Update tab akun di dashboard
          elements.accountTabsDashboard.innerHTML = "";
          elements.accountTabsTransactions.innerHTML = "";
          elements.accountTabsStatistics.innerHTML = "";
          elements.accountList.innerHTML = "";

          userAccounts.forEach((account) => {
            // Tab untuk dashboard
            const dashboardTab = document.createElement("div");
            dashboardTab.className = `account-tab ${
              account.id === app.currentAccount?.id ? "active" : ""
            }`;
            dashboardTab.textContent = account.name;
            dashboardTab.style.backgroundColor =
              account.id === app.currentAccount?.id ? account.color : "";
            dashboardTab.style.borderColor = account.color;
            dashboardTab.style.color =
              account.id === app.currentAccount?.id ? "white" : "inherit";

            dashboardTab.addEventListener("click", function () {
              app.currentAccount = account;
              saveData();

              // Update semua tab
              document
                .querySelectorAll("#accountTabsDashboard .account-tab")
                .forEach((tab) => {
                  tab.classList.remove("active");
                  tab.style.backgroundColor = "";
                  tab.style.color = "inherit";
                });

              this.classList.add("active");
              this.style.backgroundColor = account.color;
              this.style.color = "white";

              // Update tab di halaman lain
              updateAccountTabs();

              // Update dashboard dan transaksi
              updateDashboard();
              loadTransactions();

              showNotification(`Akun ${account.name} dipilih`, "success");
            });

            elements.accountTabsDashboard.appendChild(dashboardTab);

            // Tab untuk transaksi
            const transactionTab = dashboardTab.cloneNode(true);
            elements.accountTabsTransactions.appendChild(transactionTab);

            // Tab untuk statistik
            const statisticTab = dashboardTab.cloneNode(true);
            elements.accountTabsStatistics.appendChild(statisticTab);

            // Daftar akun di pengaturan
            const accountItem = document.createElement("div");
            accountItem.className = "transaction-item";
            accountItem.innerHTML = `
                        <div class="transaction-info">
                            <div class="transaction-title">${account.name}</div>
                            <div class="transaction-meta">
                                <span>Saldo: Rp ${formatCurrency(
                                  account.balance
                                )}</span>
                                <span class="category-badge" style="background-color: ${
                                  account.color
                                }20; color: ${account.color}">${
              account.name
            }</span>
                            </div>
                        </div>
                        <div class="transaction-actions">
                            <button class="btn btn-icon btn-secondary edit-account" data-id="${
                              account.id
                            }">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-icon btn-danger delete-account" data-id="${
                              account.id
                            }">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;

            elements.accountList.appendChild(accountItem);
          });

          // Update dropdown akun di form transaksi
          updateAccountDropdown();

          // Tambahkan event listener untuk edit dan hapus akun
          document.querySelectorAll(".edit-account").forEach((button) => {
            button.addEventListener("click", function () {
              const accountId = this.getAttribute("data-id");
              editAccount(accountId);
            });
          });

          document.querySelectorAll(".delete-account").forEach((button) => {
            button.addEventListener("click", function () {
              const accountId = this.getAttribute("data-id");
              deleteAccount(accountId);
            });
          });

          // Update semua tab di halaman lain
          updateAccountTabs();
        }

        // Fungsi untuk update tab akun di semua halaman
        function updateAccountTabs() {
          const userAccounts = app.accounts.filter(
            (account) => account.userId === app.currentUser.id
          );

          // Update tab di transaksi
          const transactionTabs = document.querySelectorAll(
            "#accountTabsTransactions .account-tab"
          );
          transactionTabs.forEach((tab, index) => {
            const account = userAccounts[index];
            if (account) {
              tab.classList.toggle(
                "active",
                account.id === app.currentAccount?.id
              );
              tab.style.backgroundColor =
                account.id === app.currentAccount?.id ? account.color : "";
              tab.style.color =
                account.id === app.currentAccount?.id ? "white" : "inherit";
            }
          });

          // Update tab di statistik
          const statisticTabs = document.querySelectorAll(
            "#accountTabsStatistics .account-tab"
          );
          statisticTabs.forEach((tab, index) => {
            const account = userAccounts[index];
            if (account) {
              tab.classList.toggle(
                "active",
                account.id === app.currentAccount?.id
              );
              tab.style.backgroundColor =
                account.id === app.currentAccount?.id ? account.color : "";
              tab.style.color =
                account.id === app.currentAccount?.id ? "white" : "inherit";
            }
          });
        }

        // Fungsi untuk update dropdown akun di form transaksi
        function updateAccountDropdown() {
          if (!app.currentUser) return;

          const userAccounts = app.accounts.filter(
            (account) => account.userId === app.currentUser.id
          );
          elements.transactionAccount.innerHTML = "";

          userAccounts.forEach((account) => {
            const option = document.createElement("option");
            option.value = account.id;
            option.textContent = account.name;
            if (account.id === app.currentAccount?.id) {
              option.selected = true;
            }
            elements.transactionAccount.appendChild(option);
          });
        }

        // Fungsi untuk update kategori berdasarkan jenis transaksi
        elements.transactionType.addEventListener("change", function () {
          const type = this.value;
          const categories = app.categories[type];

          elements.transactionCategory.innerHTML = "";

          categories.forEach((category) => {
            const option = document.createElement("option");
            option.value = category;
            option.textContent = category;
            elements.transactionCategory.appendChild(option);
          });
        });

        // Trigger perubahan awal untuk mengisi kategori
        elements.transactionType.dispatchEvent(new Event("change"));

        // Fungsi untuk format mata uang
        function formatCurrency(amount) {
          return new Intl.NumberFormat("id-ID").format(amount);
        }

        // Fungsi untuk menghitung saldo akun dari semua transaksi
        function calculateAccountBalanceFromTransactions(account) {
          if (!account) return 0;

          // Filter transaksi untuk akun ini
          const accountTransactions = app.transactions.filter(
            (transaction) => transaction.accountId === account.id
          );

          // Hitung total pemasukan dan pengeluaran
          const totalIncome = accountTransactions
            .filter((t) => t.type === "income")
            .reduce((sum, t) => sum + t.amount, 0);

          const totalExpense = accountTransactions
            .filter((t) => t.type === "expense")
            .reduce((sum, t) => sum + t.amount, 0);

          // Saldo = saldo awal + total pemasukan - total pengeluaran
          return account.balance + totalIncome - totalExpense;
        }

        // Fungsi untuk update dashboard dengan perhitungan yang benar
        function updateDashboard() {
          if (!app.currentUser || !app.currentAccount) return;

          // Filter transaksi untuk akun saat ini
          const accountTransactions = app.transactions.filter(
            (transaction) => transaction.accountId === app.currentAccount.id
          );

          // Hitung total pemasukan (dari semua transaksi income)
          const totalIncome = accountTransactions
            .filter((t) => t.type === "income")
            .reduce((sum, t) => sum + t.amount, 0);

          // Hitung total pengeluaran (dari semua transaksi expense)
          const totalExpense = accountTransactions
            .filter((t) => t.type === "expense")
            .reduce((sum, t) => sum + t.amount, 0);

          // Hitung saldo akhir (saldo awal + pemasukan - pengeluaran)
          const finalBalance = calculateAccountBalanceFromTransactions(
            app.currentAccount
          );

          // Update tampilan
          elements.totalBalance.textContent = `Rp ${formatCurrency(
            finalBalance
          )}`;
          elements.totalIncome.textContent = `Rp ${formatCurrency(
            totalIncome
          )}`;
          elements.totalExpense.textContent = `Rp ${formatCurrency(
            totalExpense
          )}`;

          // Update transaksi terbaru
          updateRecentTransactions(accountTransactions);

          // Update chart
          updateCharts(accountTransactions);

          // Update saldo di daftar akun
          updateAccountListBalance();
        }

        // Fungsi untuk update saldo di daftar akun
        function updateAccountListBalance() {
          document
            .querySelectorAll("#accountList .transaction-item")
            .forEach((item) => {
              const accountId = item
                .querySelector(".edit-account")
                .getAttribute("data-id");
              const account = app.accounts.find((acc) => acc.id === accountId);

              if (account) {
                const calculatedBalance =
                  calculateAccountBalanceFromTransactions(account);
                const balanceSpan = item.querySelector(
                  ".transaction-meta span:first-child"
                );
                if (balanceSpan) {
                  balanceSpan.textContent = `Saldo: Rp ${formatCurrency(
                    calculatedBalance
                  )}`;
                }
              }
            });
        }

        // Fungsi untuk update transaksi terbaru
        function updateRecentTransactions(transactions) {
          elements.recentTransactions.innerHTML = "";

          // Urutkan berdasarkan tanggal terbaru
          const sortedTransactions = [...transactions]
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 5);

          if (sortedTransactions.length === 0) {
            const emptyItem = document.createElement("div");
            emptyItem.className = "transaction-item";
            emptyItem.innerHTML =
              '<div class="transaction-info"><div class="transaction-title">Belum ada transaksi</div></div>';
            elements.recentTransactions.appendChild(emptyItem);
            return;
          }

          sortedTransactions.forEach((transaction) => {
            const item = document.createElement("li");
            item.className = "transaction-item";
            item.innerHTML = `
                        <div class="transaction-info">
                            <div class="transaction-title">${
                              transaction.description
                            }</div>
                            <div class="transaction-meta">
                                <span>${formatDate(transaction.date)}</span>
                                <span class="category-badge ${
                                  transaction.type === "income"
                                    ? "badge-income"
                                    : "badge-expense"
                                }">
                                    ${transaction.category}
                                </span>
                            </div>
                        </div>
                        <div class="transaction-amount ${transaction.type}">
                            ${
                              transaction.type === "income" ? "+" : "-"
                            }Rp ${formatCurrency(transaction.amount)}
                        </div>
                    `;

            elements.recentTransactions.appendChild(item);
          });
        }

        // Fungsi untuk update chart
        function updateCharts(transactions) {
          // Data untuk chart bulanan
          const currentDate = new Date();
          const currentMonthData = transactions.filter((t) => {
            const transDate = new Date(t.date);
            return (
              transDate.getMonth() === currentDate.getMonth() &&
              transDate.getFullYear() === currentDate.getFullYear()
            );
          });

          // Siapkan data untuk chart batang (pemasukan vs pengeluaran per minggu)
          const weeks = [1, 2, 3, 4];
          const weeklyIncome = weeks.map((week) => {
            return currentMonthData
              .filter(
                (t) =>
                  t.type === "income" &&
                  getWeekOfMonth(new Date(t.date)) === week
              )
              .reduce((sum, t) => sum + t.amount, 0);
          });

          const weeklyExpense = weeks.map((week) => {
            return currentMonthData
              .filter(
                (t) =>
                  t.type === "expense" &&
                  getWeekOfMonth(new Date(t.date)) === week
              )
              .reduce((sum, t) => sum + t.amount, 0);
          });

          // Chart batang
          const barCtx = document.getElementById("barChart").getContext("2d");

          if (barChart) {
            barChart.destroy();
          }

          barChart = new Chart(barCtx, {
            type: "bar",
            data: {
              labels: ["Minggu 1", "Minggu 2", "Minggu 3", "Minggu 4"],
              datasets: [
                {
                  label: "Pemasukan",
                  data: weeklyIncome,
                  backgroundColor: "rgba(46, 204, 113, 0.7)",
                  borderColor: "rgba(46, 204, 113, 1)",
                  borderWidth: 1,
                },
                {
                  label: "Pengeluaran",
                  data: weeklyExpense,
                  backgroundColor: "rgba(231, 76, 60, 0.7)",
                  borderColor: "rgba(231, 76, 60, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return "Rp " + formatCurrency(value);
                    },
                  },
                },
              },
              plugins: {
                legend: {
                  position: "top",
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      let label = context.dataset.label || "";
                      if (label) {
                        label += ": ";
                      }
                      label += "Rp " + formatCurrency(context.raw);
                      return label;
                    },
                  },
                },
              },
            },
          });

          // Data untuk chart pie (pengeluaran per kategori)
          const expenseTransactions = currentMonthData.filter(
            (t) => t.type === "expense"
          );
          const expenseByCategory = {};

          expenseTransactions.forEach((t) => {
            if (!expenseByCategory[t.category]) {
              expenseByCategory[t.category] = 0;
            }
            expenseByCategory[t.category] += t.amount;
          });

          const pieCtx = document.getElementById("pieChart").getContext("2d");
          const categoryColors = [
            "#FF6384",
            "#36A2EB",
            "#FFCE56",
            "#4BC0C0",
            "#9966FF",
            "#FF9F40",
            "#8AC926",
            "#1982C4",
          ];

          if (pieChart) {
            pieChart.destroy();
          }

          pieChart = new Chart(pieCtx, {
            type: "pie",
            data: {
              labels: Object.keys(expenseByCategory),
              datasets: [
                {
                  data: Object.values(expenseByCategory),
                  backgroundColor: categoryColors.slice(
                    0,
                    Object.keys(expenseByCategory).length
                  ),
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const label = context.label || "";
                      const value = context.raw || 0;
                      const total = context.dataset.data.reduce(
                        (a, b) => a + b,
                        0
                      );
                      const percentage = Math.round((value / total) * 100);
                      return `${label}: Rp ${formatCurrency(
                        value
                      )} (${percentage}%)`;
                    },
                  },
                },
              },
            },
          });
        }

        // Fungsi untuk mendapatkan minggu ke berapa dalam bulan
        function getWeekOfMonth(date) {
          const firstDay = new Date(
            date.getFullYear(),
            date.getMonth(),
            1
          ).getDay();
          const offsetDate = date.getDate() + firstDay - 1;
          return Math.floor(offsetDate / 7) + 1;
        }

        // Fungsi untuk memformat tanggal
        function formatDate(dateString) {
          const date = new Date(dateString);
          const day = date.getDate().toString().padStart(2, "0");
          const month = (date.getMonth() + 1).toString().padStart(2, "0");
          const year = date.getFullYear();
          return `${day}/${month}/${year}`;
        }

        // Fungsi untuk memuat dan menampilkan transaksi
        function loadTransactions(filter = app.currentFilter) {
          if (!app.currentUser || !app.currentAccount) return;

          // Filter transaksi untuk akun saat ini
          let accountTransactions = app.transactions.filter(
            (transaction) => transaction.accountId === app.currentAccount.id
          );

          // Terapkan filter tambahan
          if (filter === "income") {
            accountTransactions = accountTransactions.filter(
              (t) => t.type === "income"
            );
          } else if (filter === "expense") {
            accountTransactions = accountTransactions.filter(
              (t) => t.type === "expense"
            );
          }

          // Urutkan berdasarkan tanggal terbaru
          accountTransactions.sort(
            (a, b) => new Date(b.date) - new Date(a.date)
          );

          // Update tampilan
          elements.transactionHistory.innerHTML = "";

          if (accountTransactions.length === 0) {
            const emptyItem = document.createElement("div");
            emptyItem.className = "transaction-item";
            emptyItem.innerHTML =
              '<div class="transaction-info"><div class="transaction-title">Belum ada transaksi</div></div>';
            elements.transactionHistory.appendChild(emptyItem);
            return;
          }

          accountTransactions.forEach((transaction) => {
            const item = document.createElement("li");
            item.className = "transaction-item";
            item.innerHTML = `
                        <div class="transaction-info">
                            <div class="transaction-title">${
                              transaction.description
                            }</div>
                            <div class="transaction-meta">
                                <span>${formatDate(transaction.date)}</span>
                                <span class="category-badge ${
                                  transaction.type === "income"
                                    ? "badge-income"
                                    : "badge-expense"
                                }">
                                    ${transaction.category}
                                </span>
                            </div>
                        </div>
                        <div class="transaction-amount ${transaction.type}">
                            ${
                              transaction.type === "income" ? "+" : "-"
                            }Rp ${formatCurrency(transaction.amount)}
                        </div>
                        <div class="transaction-actions">
                            <button class="btn btn-icon btn-secondary edit-transaction" data-id="${
                              transaction.id
                            }">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-icon btn-danger delete-transaction" data-id="${
                              transaction.id
                            }">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;

            elements.transactionHistory.appendChild(item);
          });

          // Tambahkan event listener untuk edit dan hapus transaksi
          document.querySelectorAll(".edit-transaction").forEach((button) => {
            button.addEventListener("click", function () {
              const transactionId = this.getAttribute("data-id");
              editTransaction(transactionId);
            });
          });

          document.querySelectorAll(".delete-transaction").forEach((button) => {
            button.addEventListener("click", function () {
              const transactionId = this.getAttribute("data-id");
              deleteTransaction(transactionId);
            });
          });
        }

        // Event listener untuk filter transaksi
        elements.filterAll.addEventListener("click", function () {
          app.currentFilter = "all";
          loadTransactions("all");
          updateActiveFilterButton(this);
        });

        elements.filterIncome.addEventListener("click", function () {
          app.currentFilter = "income";
          loadTransactions("income");
          updateActiveFilterButton(this);
        });

        elements.filterExpense.addEventListener("click", function () {
          app.currentFilter = "expense";
          loadTransactions("expense");
          updateActiveFilterButton(this);
        });

        // Fungsi untuk update tombol filter aktif
        function updateActiveFilterButton(activeButton) {
          const filterButtons = [
            elements.filterAll,
            elements.filterIncome,
            elements.filterExpense,
          ];
          filterButtons.forEach((button) =>
            button.classList.remove("btn-primary")
          );
          filterButtons.forEach((button) =>
            button.classList.add("btn-secondary")
          );

          activeButton.classList.remove("btn-secondary");
          activeButton.classList.add("btn-primary");
        }

        // Event listener untuk tombol tambah transaksi
        elements.addTransactionBtn.addEventListener("click", function () {
          if (!app.currentUser) {
            showNotification("Silakan login terlebih dahulu", "error");
            return;
          }

          // Reset form
          elements.transactionId.value = "";
          elements.transactionType.value = "income";
          elements.transactionCategory.innerHTML = "";
          elements.transactionAmount.value = "";
          elements.transactionDescription.value = "";
          elements.transactionDate.value = new Date()
            .toISOString()
            .split("T")[0];

          // Trigger perubahan untuk mengisi kategori
          elements.transactionType.dispatchEvent(new Event("change"));

          // Update dropdown akun
          updateAccountDropdown();

          // Buka modal
          openModal("transactionModal");
        });

        // Event listener untuk tombol batal transaksi
        elements.cancelTransaction.addEventListener("click", function () {
          closeModal("transactionModal");
        });

        // Event listener untuk simpan transaksi
        elements.saveTransaction.addEventListener("click", function () {
          saveTransaction();
        });

        // Fungsi untuk menyimpan transaksi
        function saveTransaction() {
          const id = elements.transactionId.value;
          const type = elements.transactionType.value;
          const category = elements.transactionCategory.value;
          const amount = parseFloat(elements.transactionAmount.value);
          const description = elements.transactionDescription.value.trim();
          const date = elements.transactionDate.value;
          const accountId = elements.transactionAccount.value;

          // Validasi
          if (!category || !amount || !description || !date || !accountId) {
            showNotification("Harap isi semua field", "error");
            return;
          }

          if (amount <= 0) {
            showNotification("Jumlah harus lebih dari 0", "error");
            return;
          }

          // Cari akun
          const account = app.accounts.find((acc) => acc.id === accountId);
          if (!account) {
            showNotification("Akun tidak ditemukan", "error");
            return;
          }

          if (id) {
            // Edit transaksi yang ada
            const transactionIndex = app.transactions.findIndex(
              (t) => t.id === id
            );
            if (transactionIndex !== -1) {
              const oldTransaction = app.transactions[transactionIndex];

              // Update transaksi
              app.transactions[transactionIndex] = {
                ...oldTransaction,
                type,
                category,
                amount,
                description,
                date,
                accountId,
              };

              showNotification("Transaksi berhasil diperbarui", "success");
            }
          } else {
            // Tambah transaksi baru
            const newTransaction = {
              id: Date.now().toString(),
              userId: app.currentUser.id,
              accountId,
              type,
              category,
              amount,
              description,
              date,
              createdAt: new Date().toISOString(),
            };

            app.transactions.push(newTransaction);

            showNotification("Transaksi berhasil ditambahkan", "success");
          }

          // Simpan data
          saveData();

          // Tutup modal
          closeModal("transactionModal");

          // Update tampilan
          updateDashboard();
          loadTransactions();
          loadAccounts();
        }

        // Fungsi untuk edit transaksi
        function editTransaction(transactionId) {
          const transaction = app.transactions.find(
            (t) => t.id === transactionId
          );

          if (!transaction) {
            showNotification("Transaksi tidak ditemukan", "error");
            return;
          }

          // Isi form dengan data transaksi
          elements.transactionId.value = transaction.id;
          elements.transactionType.value = transaction.type;
          elements.transactionCategory.innerHTML = "";
          elements.transactionAmount.value = transaction.amount;
          elements.transactionDescription.value = transaction.description;
          elements.transactionDate.value = transaction.date;
          elements.transactionAccount.value = transaction.accountId;

          // Trigger perubahan untuk mengisi kategori
          elements.transactionType.dispatchEvent(new Event("change"));

          // Set kategori yang dipilih
          setTimeout(() => {
            elements.transactionCategory.value = transaction.category;
          }, 100);

          // Buka modal
          openModal("transactionModal");
        }

        // Fungsi untuk hapus transaksi
        function deleteTransaction(transactionId) {
          if (!confirm("Apakah Anda yakin ingin menghapus transaksi ini?")) {
            return;
          }

          const transactionIndex = app.transactions.findIndex(
            (t) => t.id === transactionId
          );

          if (transactionIndex === -1) {
            showNotification("Transaksi tidak ditemukan", "error");
            return;
          }

          // Hapus transaksi
          app.transactions.splice(transactionIndex, 1);

          // Simpan data
          saveData();

          // Update tampilan
          updateDashboard();
          loadTransactions();
          loadAccounts();

          showNotification("Transaksi berhasil dihapus", "success");
        }

        // Event listener untuk tombol tambah akun
        elements.addAccountBtn.addEventListener("click", function () {
          // Reset form
          elements.accountId.value = "";
          elements.accountName.value = "";
          elements.accountBalance.value = "0";
          elements.accountColor.value = "#4361ee";

          // Buka modal
          openModal("accountModal");
        });

        // Event listener untuk tombol batal akun
        elements.cancelAccount.addEventListener("click", function () {
          closeModal("accountModal");
        });

        // Event listener untuk simpan akun
        elements.saveAccount.addEventListener("click", function () {
          saveAccount();
        });

        // Fungsi untuk menyimpan akun
        function saveAccount() {
          const id = elements.accountId.value;
          const name = elements.accountName.value.trim();
          const balance = parseFloat(elements.accountBalance.value);
          const color = elements.accountColor.value;

          // Validasi
          if (!name) {
            showNotification("Harap isi nama akun", "error");
            return;
          }

          if (!app.currentUser) {
            showNotification("Silakan login terlebih dahulu", "error");
            return;
          }

          if (id) {
            // Edit akun yang ada
            const accountIndex = app.accounts.findIndex((a) => a.id === id);
            if (accountIndex !== -1) {
              // Simpan saldo lama untuk perhitungan ulang
              const oldBalance = app.accounts[accountIndex].balance;

              app.accounts[accountIndex] = {
                ...app.accounts[accountIndex],
                name,
                balance,
                color,
              };
              app.currentAccount = app.accounts[accountIndex];

              showNotification("Akun berhasil diperbarui", "success");
            }
          } else {
            // Tambah akun baru
            const newAccount = {
              id: Date.now().toString() + "_acc",
              userId: app.currentUser.id,
              name,
              balance,
              color,
              createdAt: new Date().toISOString(),
            };

            app.accounts.push(newAccount);

            // Set sebagai akun saat ini jika ini akun pertama
            if (
              app.accounts.filter((a) => a.userId === app.currentUser.id)
                .length === 1
            ) {
              app.currentAccount = newAccount;
            }

            showNotification("Akun berhasil ditambahkan", "success");
          }

          // Simpan data
          saveData();

          // Tutup modal
          closeModal("accountModal");

          // Update tampilan
          loadAccounts();
          updateDashboard();
        }

        // Fungsi untuk edit akun
        function editAccount(accountId) {
          const account = app.accounts.find((a) => a.id === accountId);

          if (!account) {
            showNotification("Akun tidak ditemukan", "error");
            return;
          }

          // Isi form dengan data akun
          elements.accountId.value = account.id;
          elements.accountName.value = account.name;
          elements.accountBalance.value = account.balance;
          elements.accountColor.value = account.color;

          // Buka modal
          openModal("accountModal");
        }

        // Fungsi untuk hapus akun
        function deleteAccount(accountId) {
          if (
            !confirm(
              "Apakah Anda yakin ingin menghapus akun ini? Semua transaksi di akun ini juga akan dihapus."
            )
          ) {
            return;
          }

          // Cari akun
          const accountIndex = app.accounts.findIndex(
            (a) => a.id === accountId
          );

          if (accountIndex === -1) {
            showNotification("Akun tidak ditemukan", "error");
            return;
          }

          // Hapus semua transaksi di akun ini
          const userTransactions = app.transactions.filter(
            (t) => t.accountId === accountId
          );
          userTransactions.forEach((transaction, index) => {
            const transIndex = app.transactions.findIndex(
              (t) => t.id === transaction.id
            );
            if (transIndex !== -1) {
              app.transactions.splice(transIndex, 1);
            }
          });

          // Hapus akun
          app.accounts.splice(accountIndex, 1);

          // Jika akun yang dihapus adalah akun saat ini, pilih akun lain
          if (app.currentAccount && app.currentAccount.id === accountId) {
            const userAccounts = app.accounts.filter(
              (a) => a.userId === app.currentUser.id
            );
            if (userAccounts.length > 0) {
              app.currentAccount = userAccounts[0];
            } else {
              app.currentAccount = null;
            }
          }

          // Simpan data
          saveData();

          // Update tampilan
          loadAccounts();
          updateDashboard();
          loadTransactions();

          showNotification("Akun berhasil dihapus", "success");
        }

        // Event listener untuk update profil
        elements.updateProfile.addEventListener("click", function () {
          const name = elements.userFullName.value.trim();
          const email = elements.userEmail.value.trim();

          // Validasi
          if (!name || !email) {
            showNotification("Harap isi semua field", "error");
            return;
          }

          if (!app.currentUser) {
            showNotification("Silakan login terlebih dahulu", "error");
            return;
          }

          // Update data pengguna
          const userIndex = app.users.findIndex(
            (u) => u.id === app.currentUser.id
          );
          if (userIndex !== -1) {
            // Cek apakah email sudah digunakan oleh pengguna lain
            const emailExists = app.users.some(
              (u) => u.email === email && u.id !== app.currentUser.id
            );
            if (emailExists) {
              showNotification(
                "Email sudah digunakan oleh pengguna lain",
                "error"
              );
              return;
            }

            app.users[userIndex].name = name;
            app.users[userIndex].email = email;
            app.currentUser = app.users[userIndex];

            // Simpan data
            saveData();

            // Update tampilan
            updateUserDisplay();

            showNotification("Profil berhasil diperbarui", "success");
          }
        });

        // Event listener untuk logout
        elements.logoutBtn.addEventListener("click", function () {
          if (!confirm("Apakah Anda yakin ingin keluar?")) {
            return;
          }

          // Reset data sesi
          app.currentUser = null;
          app.currentAccount = null;

          // Tampilkan halaman auth dan sembunyikan aplikasi utama
          elements.authPage.style.display = "flex";
          elements.mainApp.style.display = "none";

          // Reset form login
          elements.loginEmail.value = "";
          elements.loginPassword.value = "";

          showNotification("Anda telah keluar", "success");
        });

        // Event listener untuk generate laporan
        elements.generateReport.addEventListener("click", function () {
          generateReport();
        });

        // Event listener untuk export PDF
        elements.exportPDF.addEventListener("click", function () {
          exportToPDF();
        });

        // Event listener untuk perubahan periode laporan
        elements.reportPeriod.addEventListener("change", function () {
          const period = this.value;

          if (period === "yearly") {
            elements.periodLabel.textContent = "Tahun";
            elements.reportMonth.innerHTML = "";

            // Tambahkan opsi tahun (3 tahun terakhir)
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 2; i--) {
              const option = document.createElement("option");
              option.value = i;
              option.textContent = i;
              elements.reportMonth.appendChild(option);
            }
          } else {
            elements.periodLabel.textContent = "Bulan";
            populateMonthOptions();
          }
        });

        // Fungsi untuk generate laporan
        function generateReport() {
          if (!app.currentUser || !app.currentAccount) {
            showNotification("Silakan login terlebih dahulu", "error");
            return;
          }

          const period = elements.reportPeriod.value;
          const periodValue = elements.reportMonth.value;

          // Filter transaksi untuk akun saat ini
          let accountTransactions = app.transactions.filter(
            (transaction) => transaction.accountId === app.currentAccount.id
          );

          let reportTitle = "";
          let filteredTransactions = [];

          if (period === "monthly") {
            const month = parseInt(periodValue);
            const year = new Date().getFullYear();

            reportTitle = `Laporan Bulanan - ${monthNames[month]} ${year}`;

            filteredTransactions = accountTransactions.filter((t) => {
              const transDate = new Date(t.date);
              return (
                transDate.getMonth() === month &&
                transDate.getFullYear() === year
              );
            });
          } else {
            const year = parseInt(periodValue);

            reportTitle = `Laporan Tahunan - ${year}`;

            filteredTransactions = accountTransactions.filter((t) => {
              const transDate = new Date(t.date);
              return transDate.getFullYear() === year;
            });
          }

          // Hitung statistik dengan benar
          const totalIncome = filteredTransactions
            .filter((t) => t.type === "income")
            .reduce((sum, t) => sum + t.amount, 0);

          const totalExpense = filteredTransactions
            .filter((t) => t.type === "expense")
            .reduce((sum, t) => sum + t.amount, 0);

          // Saldo akhir untuk periode ini
          const balance = totalIncome - totalExpense;

          // Kategorikan pengeluaran
          const expenseByCategory = {};
          filteredTransactions
            .filter((t) => t.type === "expense")
            .forEach((t) => {
              if (!expenseByCategory[t.category]) {
                expenseByCategory[t.category] = 0;
              }
              expenseByCategory[t.category] += t.amount;
            });

          // Tampilkan hasil
          let reportHTML = `
                    <h3 style="margin-bottom: 20px;">${reportTitle}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Total Pemasukan</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">Rp ${formatCurrency(
                              totalIncome
                            )}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Total Pengeluaran</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">Rp ${formatCurrency(
                              totalExpense
                            )}</div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4361ee, #3f37c9); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="font-size: 0.9rem; opacity: 0.9;">Saldo ${
                          period === "monthly" ? "Bulan Ini" : "Tahun Ini"
                        }</div>
                        <div style="font-size: 1.8rem; font-weight: bold;">Rp ${formatCurrency(
                          balance
                        )}</div>
                    </div>
                `;

          // Tambahkan daftar pengeluaran per kategori
          if (Object.keys(expenseByCategory).length > 0) {
            reportHTML += `<h4 style="margin-bottom: 15px;">Pengeluaran per Kategori</h4>`;

            Object.keys(expenseByCategory).forEach((category) => {
              const amount = expenseByCategory[category];
              const percentage =
                totalExpense > 0
                  ? Math.round((amount / totalExpense) * 100)
                  : 0;

              reportHTML += `
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>${category}</span>
                                    <span>Rp ${formatCurrency(
                                      amount
                                    )} (${percentage}%)</span>
                                </div>
                                <div style="height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: ${percentage}%; background-color: #e74c3c;"></div>
                                </div>
                            </div>
                        `;
            });
          }

          // Tambahkan daftar transaksi
          if (filteredTransactions.length > 0) {
            reportHTML += `<h4 style="margin-top: 25px; margin-bottom: 15px;">Daftar Transaksi</h4>`;

            filteredTransactions.sort(
              (a, b) => new Date(b.date) - new Date(a.date)
            );

            filteredTransactions.slice(0, 10).forEach((transaction) => {
              reportHTML += `
                            <div style="padding: 10px 0; border-bottom: 1px solid #e9ecef;">
                                <div style="display: flex; justify-content: space-between;">
                                    <div>
                                        <div style="font-weight: 500;">${
                                          transaction.description
                                        }</div>
                                        <div style="font-size: 0.85rem; color: #6c757d;">
                                            ${formatDate(transaction.date)}  ${
                transaction.category
              }
                                        </div>
                                    </div>
                                    <div style="font-weight: 600; color: ${
                                      transaction.type === "income"
                                        ? "#2ecc71"
                                        : "#e74c3c"
                                    }">
                                        ${
                                          transaction.type === "income"
                                            ? "+"
                                            : "-"
                                        }Rp ${formatCurrency(
                transaction.amount
              )}
                                    </div>
                                </div>
                            </div>
                        `;
            });

            if (filteredTransactions.length > 10) {
              reportHTML += `<div style="text-align: center; padding: 10px; color: #6c757d;">Dan ${
                filteredTransactions.length - 10
              } transaksi lainnya</div>`;
            }
          } else {
            reportHTML += `<div style="text-align: center; padding: 20px; color: #6c757d;">Tidak ada transaksi pada periode ini</div>`;
          }

          // Tampilkan hasil
          elements.reportContent.innerHTML = reportHTML;
          elements.reportResult.style.display = "block";

          // Scroll ke hasil laporan
          elements.reportResult.scrollIntoView({ behavior: "smooth" });
        }

        // Fungsi untuk export ke PDF
        function exportToPDF() {
          if (!app.currentUser || !app.currentAccount) {
            showNotification("Silakan login terlebih dahulu", "error");
            return;
          }

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          // Data untuk PDF
          const period = elements.reportPeriod.value;
          const periodValue = elements.reportMonth.value;
          const periodText =
            period === "monthly"
              ? `${
                  monthNames[parseInt(periodValue)]
                } ${new Date().getFullYear()}`
              : `Tahun ${periodValue}`;

          // Judul
          doc.setFontSize(18);
          doc.text("Laporan Keuangan FinTrack", 105, 20, { align: "center" });

          doc.setFontSize(12);
          doc.text(`Periode: ${periodText}`, 105, 30, { align: "center" });
          doc.text(`Akun: ${app.currentAccount.name}`, 105, 37, {
            align: "center",
          });
          doc.text(`Pengguna: ${app.currentUser.name}`, 105, 44, {
            align: "center",
          });

          // Garis pemisah
          doc.setLineWidth(0.5);
          doc.line(20, 50, 190, 50);

          // Data statistik
          let yPos = 60;

          // Filter transaksi untuk periode yang dipilih
          let filteredTransactions = [];
          if (period === "monthly") {
            const month = parseInt(periodValue);
            const year = new Date().getFullYear();

            filteredTransactions = app.transactions.filter((t) => {
              if (t.accountId !== app.currentAccount.id) return false;
              const transDate = new Date(t.date);
              return (
                transDate.getMonth() === month &&
                transDate.getFullYear() === year
              );
            });
          } else {
            const year = parseInt(periodValue);

            filteredTransactions = app.transactions.filter((t) => {
              if (t.accountId !== app.currentAccount.id) return false;
              const transDate = new Date(t.date);
              return transDate.getFullYear() === year;
            });
          }

          // Hitung statistik dengan benar
          const totalIncome = filteredTransactions
            .filter((t) => t.type === "income")
            .reduce((sum, t) => sum + t.amount, 0);

          const totalExpense = filteredTransactions
            .filter((t) => t.type === "expense")
            .reduce((sum, t) => sum + t.amount, 0);

          const balance = totalIncome - totalExpense;

          // Tampilkan statistik
          doc.setFontSize(14);
          doc.text("Ringkasan Keuangan", 20, yPos);
          yPos += 10;

          doc.setFontSize(11);
          doc.text(
            `Total Pemasukan: Rp ${formatCurrency(totalIncome)}`,
            20,
            yPos
          );
          yPos += 7;
          doc.text(
            `Total Pengeluaran: Rp ${formatCurrency(totalExpense)}`,
            20,
            yPos
          );
          yPos += 7;
          doc.text(
            `Saldo ${
              period === "monthly" ? "Bulan Ini" : "Tahun Ini"
            }: Rp ${formatCurrency(balance)}`,
            20,
            yPos
          );
          yPos += 15;

          // Daftar transaksi
          if (filteredTransactions.length > 0) {
            doc.setFontSize(14);
            doc.text("Daftar Transaksi", 20, yPos);
            yPos += 10;

            // Header tabel
            doc.setFontSize(10);
            const headers = [["Tanggal", "Kategori", "Deskripsi", "Jumlah"]];
            const data = [];

            filteredTransactions.sort(
              (a, b) => new Date(b.date) - new Date(a.date)
            );

            filteredTransactions.forEach((transaction) => {
              data.push([
                formatDate(transaction.date),
                transaction.category,
                transaction.description.length > 20
                  ? transaction.description.substring(0, 20) + "..."
                  : transaction.description,
                `${
                  transaction.type === "income" ? "+" : "-"
                }Rp ${formatCurrency(transaction.amount)}`,
              ]);
            });

            // Buat tabel
            doc.autoTable({
              startY: yPos,
              head: headers,
              body: data,
              theme: "grid",
              headStyles: { fillColor: [67, 97, 238] },
              margin: { left: 20, right: 20 },
            });
          } else {
            doc.setFontSize(12);
            doc.text("Tidak ada transaksi pada periode ini", 20, yPos);
          }

          // Simpan PDF
          const fileName = `Laporan_FinTrack_${periodText.replace(
            / /g,
            "_"
          )}.pdf`;
          doc.save(fileName);

          showNotification("Laporan berhasil diexport ke PDF", "success");
        }

        // Muat data saat halaman dimuat
        loadData();

        // Inisialisasi filter button
        updateActiveFilterButton(elements.filterAll);
      });
    </script>
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/service-worker.js")
          .then(() => console.log("Service Worker registered"))
          .catch((err) => console.log("SW failed", err));
      }
    </script>
  </body>
</html>
